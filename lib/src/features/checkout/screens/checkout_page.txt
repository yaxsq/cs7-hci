import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:hci_app/src/features/models/cart_model.dart';
import 'package:hci_app/src/core/widgets/custom_button.dart';

class CheckoutPage extends StatefulWidget {
  const CheckoutPage({super.key});

  @override
  State<CheckoutPage> createState() => _CheckoutPageState();
}

class _CheckoutPageState extends State<CheckoutPage> {
  int _currentStep = 0;
  String? _selectedAddress = '123 Main St, Anytown, USA';
  String? _selectedPayment = 'Credit Card';

  @override
  Widget build(BuildContext context) {
    final cart = Provider.of<CartModel>(context);

    return Scaffold(
      backgroundColor: const Color(0xFF121212),
      appBar: AppBar(
        title: const Text('Checkout'),
        backgroundColor: const Color(0xFF1E1E1E),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back),
          onPressed: () => GoRouter.of(context).pop(),
        ),
      ),
      body: Theme(
        data: Theme.of(context).copyWith(
          colorScheme: const ColorScheme.dark(
            primary: Color(0xFF4CAF50), // Stepper active color
            onSurface: Colors.white, // Stepper text color
          ),
          canvasColor: const Color(0xFF1E1E1E), // Stepper background
        ),
        child: Stepper(
          type: StepperType.horizontal,
          currentStep: _currentStep,
          onStepContinue: () {
            if (_currentStep < 2) {
              setState(() {
                _currentStep += 1;
              });
            } else {
              // Complete order logic
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Order placed successfully!')),
              );
              GoRouter.of(context).go('/');
            }
          },
          onStepCancel: () {
            if (_currentStep > 0) {
              setState(() {
                _currentStep -= 1;
              });
            } else {
              GoRouter.of(context).pop();
            }
          },
          steps: [
            _buildStep(
              title: 'Address',
              content: _buildAddressStep(),
              isActive: _currentStep >= 0,
            ),
            _buildStep(
              title: 'Payment',
              content: _buildPaymentStep(),
              isActive: _currentStep >= 1,
            ),
            _buildStep(
              title: 'Review',
              content: _buildReviewStep(cart),
              isActive: _currentStep >= 2,
            ),
          ],
          controlsBuilder: (BuildContext context, ControlsDetails details) {
            return Padding(
              padding: const EdgeInsets.only(top: 16.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: <Widget>[
                  TextButton(
                    onPressed: details.onStepCancel,
                    child: const Text('BACK'),
                  ),
                  const SizedBox(width: 12),
                  CustomButton(
                    text: _currentStep == 2 ? 'PLACE ORDER' : 'CONTINUE',
                    onPressed: details.onStepContinue,
                  ),
                ],
              ),
            );
          },
        ),
      ),
    );
  }

  Step _buildStep({required String title, required Widget content, bool isActive = false}) {
    return Step(
      title: Text(title, style: const TextStyle(color: Colors.white)),
      content: content,
      isActive: isActive,
      state: _currentStep > 0 ? StepState.complete : StepState.indexed,
    );
  }

  Widget _buildAddressStep() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('Select Delivery Address', style: Theme.of(context).textTheme.titleLarge?.copyWith(color: Colors.white)),
        const SizedBox(height: 16),
        _buildRadioTile('123 Main St, Anytown, USA', _selectedAddress, (value) {
          setState(() {
            _selectedAddress = value;
          });
        }),
        _buildRadioTile('456 Oak Ave, Sometown, USA', _selectedAddress, (value) {
          setState(() {
            _selectedAddress = value;
          });
        }),
        TextButton.icon(
          icon: const Icon(Icons.add, color: Color(0xFF4CAF50)),
          label: const Text('Add New Address', style: TextStyle(color: Color(0xFF4CAF50))),
          onPressed: () {
            // Handle add new address
          },
        ),
      ],
    );
  }

  Widget _buildPaymentStep() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('Select Payment Method', style: Theme.of(context).textTheme.titleLarge?.copyWith(color: Colors.white)),
        const SizedBox(height: 16),
        _buildRadioTile('Credit Card', _selectedPayment, (value) {
          setState(() {
            _selectedPayment = value;
          });
        }),
        _buildRadioTile('PayPal', _selectedPayment, (value) {
          setState(() {
            _selectedPayment = value;
          });
        }),
        _buildRadioTile('Google Pay', _selectedPayment, (value) {
          setState(() {
            _selectedPayment = value;
          });
        }),
      ],
    );
  }

  Widget _buildReviewStep(CartModel cart) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('Review Your Order', style: Theme.of(context).textTheme.titleLarge?.copyWith(color: Colors.white)),
        const SizedBox(height: 16),
        // Order Summary
        ...cart.items.map((item) => ListTile(
          leading: Image.network(item.product.imageUrl, width: 50, height: 50),
          title: Text(item.product.name, style: const TextStyle(color: Colors.white)),
          subtitle: Text('Qty: ${item.quantity}', style: const TextStyle(color: Colors.white70)),
          trailing: Text('\${(item.product.price * item.quantity).toStringAsFixed(2)}', style: const TextStyle(color: Colors.white)),
        )),
        const Divider(color: Colors.grey),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text('Subtotal', style: TextStyle(color: Colors.white70, fontSize: 16)),
            Text('\${cart.totalPrice.toStringAsFixed(2)}', style: const TextStyle(color: Colors.white, fontSize: 16)),
          ],
        ),
        const SizedBox(height: 8),
        const Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text('Delivery Fee', style: TextStyle(color: Colors.white70, fontSize: 16)),
            Text('\$2.00', style: TextStyle(color: Colors.white, fontSize: 16)),
          ],
        ),
        const Divider(color: Colors.grey),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text('Total', style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 20)),
            Text('\${(cart.totalPrice + 2.0).toStringAsFixed(2)}', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 20)),
          ],
        ),
      ],
    );
  }

  Widget _buildRadioTile(String title, String? groupValue, ValueChanged<String?> onChanged) {
    return RadioListTile<String>(
      title: Text(title, style: const TextStyle(color: Colors.white)),
      value: title,
      groupValue: groupValue,
      onChanged: onChanged,
      activeColor: const Color(0xFF4CAF50),
    );
  }
}